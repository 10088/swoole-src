<?php
define('SRC_DIR', dirname(__DIR__));
define('LIB_PATH', SRC_DIR . '/php_swoole_library.h');
define('PHP_TAG', '<?php');

echo "generating swoole php library...\n";
$library_files = glob(SRC_DIR . '/library/*.php');
$eval_str = '';
foreach ($library_files as $file) {
    $code = file_get_contents($file);
    if ($code === false) {
        throw new RuntimeException("can not read file {$file}");
    }
    if (strpos($code, PHP_TAG) !== 0) {
        throw new InvalidArgumentException('swoole library php file must start with "<?php"');
    }
    // keep line breaks to align line numbers
    $code = substr($code, strlen(PHP_TAG));
    $code = str_replace(['\\', '"', "\n"], ['\\\\', '\\"', '\\n'], $code);
    $eval_str .= "zend::eval(\"{$code}\", \"{$file}\");\n";
}
$eval_str = '/**
 * Generated by ' . basename(__FILE__) . ', Please DO NOT modify!
 */' . "\n\n{$eval_str}";
if (file_put_contents(LIB_PATH, $eval_str) != strlen($eval_str)) {
    throw new RuntimeException('can not write source codes to ' . LIB_PATH);
}
echo "generated swoole php library successfully\n";
